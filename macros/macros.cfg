

[gcode_macro UNLOCK_AND_MOVE]
description: Enable motor movement without homing
gcode:
  SET_KINEMATIC_POSITION X=200 Y=200 Z=200
  G91
  RESPOND PREFIX="info" MSG="Axes unlocked. Use relative G1 moves to reposition."

[gcode_macro G32]
gcode:
  SAVE_GCODE_STATE NAME=STATE_G32
  G90
  G28
  QUAD_GANTRY_LEVEL
  G28
  PARK
  RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro PARK]
description: Park center-front, Z up
gcode:
  {% set z = params.Z|default(30)|int %}
  {% set x = printer.toolhead.axis_maximum.x|int - 20 %}
  {% set y = 20 %}
  G90
  G1 Z{min(printer.toolhead.axis_maximum.z|int, (printer.toolhead.position.z + z))} F6000
  G1 X{x} Y{y} F12000

[gcode_macro SMART_PARK]
description: Lift then park at front-right
gcode:
  {% set z = params.Z|default(15)|int %}
  G91
  G1 Z{z} F600
  G90
  G1 X{printer.toolhead.axis_minimum.x - 10} Y{printer.toolhead.axis_minimum.y - 10} F12000

[gcode_macro PRINT_START]
gcode:
  RUN_SHELL_COMMAND CMD=backup_now
  M117
  {% set EXTRUDER = params.EXTRUDER|default(240)|float %}
  {% set BED = params.BED|default(55)|float %}
  SET_NOZZLE_LEDS_ON
  RESPOND MSG="Start -> Bed {BED|int}C, Hotend {EXTRUDER|int}C"
  M140 S{BED}
  M104 S{EXTRUDER-40}
  UPDATE_DELAYED_GCODE ID=TEMP_REPORT DURATION=10
  M300 P150
  G28
  SMART_PARK
  M300 P150
  QUAD_GANTRY_LEVEL
  G28
  M300 P150
  M190 S{BED}
  BED_MESH_CLEAR
  BED_MESH_CALIBRATE
  M300 P150
  M104 S{EXTRUDER}
  M109 S{EXTRUDER}
  M300 P150
  CLEAN_NOZZLE
  M300 P150
  UPDATE_DELAYED_GCODE ID=TEMP_REPORT DURATION=0
  LED_BLUE



[delayed_gcode TEMP_REPORT]
gcode:
  RESPOND MSG="Bed {printer.heater_bed.temperature|round(1)}°C/{printer.heater_bed.target}°C  |  Hotend {printer.extruder.temperature|round(1)}°C/{printer.extruder.target}°C"
  UPDATE_DELAYED_GCODE ID=TEMP_REPORT DURATION=30

[gcode_macro PRINT_END]
gcode:
  SAVE_GCODE_STATE NAME=STATE_PRINT_END
  M400
  G92 E0
  G1 E-2 F1800
  TURN_OFF_HEATERS
  M107
  G91
  G1 Z10 F600
  G90
  G1 X10 Y300 F12000
  BED_MESH_CLEAR
  M300 S2500 P150
  M300 S2000 P150
  M300 S1500 P150
  RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0

[gcode_macro CLEAN_NOZZLE]
variable_start_x: 260
variable_start_y: 350
variable_start_z: 0
variable_wipe_dist: 50
variable_wipe_qty: 5
variable_wipe_spd: 200
variable_raise_distance: 15
gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %} G28 {% endif %}
  G90
  G1 Z{start_z} F600
  G1 X{start_x} Y{start_y} F6000
  {% for wipe in range(1, (wipe_qty + 1)) %}
    G1 X{start_x + wipe_dist} F{wipe_spd * 60}
    G1 X{start_x} F{wipe_spd * 60}
  {% endfor %}
  G1 Z{start_z + raise_distance}

[gcode_macro LOAD_FILAMENT]
variable_load_length: 100
variable_purge_length: 30
variable_load_speed: 300
variable_purge_speed: 150
gcode:
  M83
  G91
  G1 E{load_length} F{load_speed}
  G1 E{purge_length} F{purge_speed}
  G90
  BEEP

[gcode_macro UNLOAD_FILAMENT]
variable_unload_length: 100
variable_unload_speed: 300
gcode:
  M83
  G91
  G1 E-{unload_length} F{unload_speed}
  G90
  BEEP

[gcode_macro SGT]
description: Set StallGuard SGT live (−64..63)
gcode:
  {% if 'X' in params %}SET_TMC_FIELD STEPPER=stepper_x FIELD=SGT VALUE={params.X|int}{% endif %}
  {% if 'Y' in params %}SET_TMC_FIELD STEPPER=stepper_y FIELD=SGT VALUE={params.Y|int}{% endif %}
  {% if 'X' in params %}DUMP_TMC STEPPER=stepper_x{% endif %}
  {% if 'Y' in params %}DUMP_TMC STEPPER=stepper_y{% endif %}


# Beeper command
[gcode_macro M300]
gcode:
  {% set hz = params.S|default(3000)|int %}
  {% set ms = params.P|default(200)|int %}
  SET_PIN PIN=beeper VALUE=0 CYCLE_TIME={1.0/hz}
  SET_PIN PIN=beeper VALUE=0.5
  G4 P{ms}
  SET_PIN PIN=beeper VALUE=0

[gcode_macro BEEP]
description: Quick test beep
gcode:
  M300 S2000 P200

[gcode_macro RESONANCE_TEST_ALL]
description: Run X and Y resonance tests, calibrate input shaper, and bump accel
gcode:
  TEST_RESONANCES AXIS=X
  TEST_RESONANCES AXIS=Y
  SHAPER_CALIBRATE
  SET_VELOCITY_LIMIT ACCEL=8000
  RESPOND MSG="Resonance test complete. Max accel set to 8000 mm/s²"

  [gcode_macro SERVICE]
description: Move head to front-center at mid Z for access (homes if needed)
gcode:
  {% if "x" not in printer.toolhead.homed_axes
        or "y" not in printer.toolhead.homed_axes
        or "z" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}
  G90
  {% set xmid = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x) / 2 %}
  {% set zhalf = printer.toolhead.axis_maximum.z / 2 %}
  {% set yfront = params.Y|default(10)|float %}
  {% set ztarget = zhalf if zhalf > 20 else 20 %}
  G0 Z{ztarget:.2f} F6000
  G0 X{xmid:.2f} Y{yfront:.2f} F12000

  [gcode_macro LED_OFF]
gcode: SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0

[gcode_macro LED_WHITE]
gcode: SET_LED LED=sb_leds RED=1 GREEN=1 BLUE=1

[gcode_macro LED_RED]
gcode: SET_LED LED=sb_leds RED=1 GREEN=0 BLUE=0

[gcode_macro LED_GREEN]
gcode: SET_LED LED=sb_leds RED=0 GREEN=1 BLUE=0

[gcode_macro LED_BLUE]
gcode: SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=1



